name: Release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write

jobs:
    build-macos:
        runs-on: macos-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Set up version
              id: version
              run: |
                  VERSION=${GITHUB_REF#refs/tags/v}
                  echo "VERSION=$VERSION" >> $GITHUB_ENV
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "$VERSION" > VERSION

            - name: Regenerate man page (optional)
              run: |
                  if command -v pandoc >/dev/null 2>&1; then
                      make man || echo "Warning: Man page generation failed, using pre-generated version"
                  else
                      echo "Pandoc not available, using pre-generated man page from repository"
                  fi

            - name: Build macOS universal binary
              env:
                  VERSION: ${{ env.VERSION }}
                  SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY || '-' }}
              run: |
                  cmake --version
                  make release-macos SIGNING_IDENTITY="${SIGNING_IDENTITY}" 2>&1 | tee build.log || (tail -100 build.log && exit 1)

            - name: Create checksums
              env:
                  VERSION: ${{ env.VERSION }}
              run: |
                  cd release
                  shasum -a 256 apex-${VERSION}-macos-universal.tar.gz > apex-${VERSION}-macos-universal.tar.gz.sha256
                  cat apex-${VERSION}-macos-universal.tar.gz.sha256

            - name: Upload macOS release
              uses: softprops/action-gh-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  files: |
                      release/apex-${{ env.VERSION }}-macos-universal.tar.gz
                      release/apex-${{ env.VERSION }}-macos-universal.tar.gz.sha256

    build-linux:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Set up version
              id: version
              run: |
                  VERSION=${GITHUB_REF#refs/tags/v}
                  echo "VERSION=$VERSION" >> $GITHUB_ENV
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Version: $VERSION"
                  echo "$VERSION" > VERSION

            - name: Regenerate man page (optional)
              run: |
                  if command -v pandoc >/dev/null 2>&1; then
                      make man || echo "Warning: Man page generation failed, using pre-generated version"
                  else
                      echo "Pandoc not available, using pre-generated man page from repository"
                  fi

            - name: Build Linux binary
              env:
                  VERSION: ${{ env.VERSION }}
              run: |
                  make release-linux

            - name: Create checksums
              env:
                  VERSION: ${{ env.VERSION }}
              run: |
                  cd release
                  sha256sum apex-${VERSION}-linux-*.tar.gz > apex-${VERSION}-linux-x86_64.tar.gz.sha256
                  cat apex-${VERSION}-linux-*.tar.gz.sha256

            - name: Upload Linux release
              uses: softprops/action-gh-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  files: |
                      release/apex-${{ env.VERSION }}-linux-*.tar.gz
                      release/apex-${{ env.VERSION }}-linux-*.tar.gz.sha256

    build-linux-arm:
        runs-on: ubuntu-24.04-arm
        steps:
            - uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Set up version
              id: version
              run: |
                  VERSION=${GITHUB_REF#refs/tags/v}
                  echo "VERSION=$VERSION" >> $GITHUB_ENV
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Version: $VERSION"
                  echo "$VERSION" > VERSION

            - name: Regenerate man page (optional)
              run: |
                  if command -v pandoc >/dev/null 2>&1; then
                      make man || echo "Warning: Man page generation failed, using pre-generated version"
                  else
                      echo "Pandoc not available, using pre-generated man page from repository"
                  fi

            - name: Build Linux ARM binary
              env:
                  VERSION: ${{ env.VERSION }}
              run: |
                  make release-linux

            - name: Create checksums
              env:
                  VERSION: ${{ env.VERSION }}
              run: |
                  cd release
                  sha256sum apex-${VERSION}-linux-*.tar.gz > apex-${VERSION}-linux-aarch64.tar.gz.sha256
                  cat apex-${VERSION}-linux-*.tar.gz.sha256

            - name: Upload Linux ARM release
              uses: softprops/action-gh-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  files: |
                      release/apex-${{ env.VERSION }}-linux-*.tar.gz
                      release/apex-${{ env.VERSION }}-linux-*.tar.gz.sha256
